
"use strict";var RoleElementComponent_1,__decorate=this&&this.__decorate||function(t,e,n,i){var s,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var h=t.length-1;0<=h;h--)(s=t[h])&&(r=(o<3?s(r):3<o?s(e,n,r):s(e,n))||r);return 3<o&&r&&Object.defineProperty(e,n,r),r};Object.defineProperty(exports,"__esModule",{value:!0}),exports.RoleElementComponent=void 0;const Protocol_1=require("../../../../../Core/Define/Net/Protocol"),EntityComponent_1=require("../../../../../Core/Entity/EntityComponent"),EventDefine_1=require("../../../../Common/Event/EventDefine"),EventSystem_1=require("../../../../Common/Event/EventSystem"),ModelManager_1=require("../../../../Manager/ModelManager"),FormationDataController_1=require("../../../../Module/Abilities/FormationDataController"),PhantomUtil_1=require("../../../../Module/Phantom/PhantomUtil"),CharacterAttributeTypes_1=require("../../Common/Component/Abilities/CharacterAttributeTypes"),CharacterBuffIds_1=require("../../Common/Component/Abilities/CharacterBuffIds");var EAttributeId=Protocol_1.Aki.Protocol.EAttributeType;const RegisterComponent_1=require("../../../../../Core/Entity/RegisterComponent");let RoleElementComponent=RoleElementComponent_1=class RoleElementComponent extends EntityComponent_1.EntityComponent{constructor(){super(...arguments),this.U6r=void 0,this.yte=void 0,this.aat=void 0,this.wXo=void 0,this.BXo=!1,this.bXo=!1,this.iKe=(t,e,n)=>{var i=this.RoleElementType;e<Number.EPSILON?this.qXo=!1:this.GXo(e),EventSystem_1.EventSystem.EmitWithTarget(this.Entity,EventDefine_1.EEventName.CharOnElementEnergyChanged,i,e,n),EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.CharOnElementEnergyChanged,i,e,n)},this.Lqo=t=>{FormationDataController_1.FormationDataController.GlobalIsInFight&&(this.BXo=!0)},this.ppe=t=>{(this.BXo=t)||(this.qXo=!1)},this.NXo=()=>{this.BXo&&(this.GXo(this.RoleElementEnergy),this.BXo=!1)},this.OXo=()=>{this.U6r?.IsAutonomousProxy&&this.kXo(this.Entity)},this.XXe=()=>{this.U6r?.IsAutonomousProxy&&this.kXo(this.Entity)}}OnStart(){this.U6r=this.Entity.GetComponent(3),this.yte=this.Entity.CheckGetComponent(155),this.aat=this.Entity.CheckGetComponent(156),this.yte.AddListener(this.FXo,this.iKe,"RoleElementComponent"),EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.RoleOnStateInherit,this.Lqo),EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.AllRevive,this.OXo),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.OnBattleStateChanged,this.ppe),EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.CharOnRoleDeadTargetSelf,this.XXe),EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.CharHit,this.NXo),EventSystem_1.EventSystem.AddWithTarget(this.Entity,EventDefine_1.EEventName.CharBeHit,this.NXo),this.wXo=PhantomUtil_1.PhantomUtil.GetSummonedEntity(this.Entity,Protocol_1.Aki.Protocol.ESummonType.ESummonTypeConcomitantCustom);var t=this.wXo?.Entity;return t&&!EventSystem_1.EventSystem.HasWithTarget(t,EventDefine_1.EEventName.CharHit,this.NXo)&&EventSystem_1.EventSystem.AddWithTarget(t,EventDefine_1.EEventName.CharHit,this.NXo),this.BXo=!0}OnEnd(){return this.yte.RemoveListener(this.FXo,this.iKe),EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.RoleOnStateInherit,this.Lqo),EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.AllRevive,this.OXo),EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.CharOnRoleDeadTargetSelf,this.XXe),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.OnBattleStateChanged,this.ppe),EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.CharHit,this.NXo),EventSystem_1.EventSystem.RemoveWithTarget(this.Entity,EventDefine_1.EEventName.CharBeHit,this.NXo),this.wXo?.Valid&&EventSystem_1.EventSystem.RemoveWithTarget(this.wXo.Entity,EventDefine_1.EEventName.CharHit,this.NXo),this.wXo=void 0,!(this.BXo=!1)}set qXo(t){this.bXo!==t&&this.U6r?.IsAutonomousProxy&&(this.bXo=t,t=RoleElementComponent_1.VXo.get(this.RoleElementType),this.bXo?(this.aat.AddBuff(ModelManager_1.ModelManager.GameModeModel.IsMulti?CharacterBuffIds_1.buffId.ActivateMultiQte:CharacterBuffIds_1.buffId.ActivateQte,{InstigatorId:this.aat.CreatureDataId,Reason:"RoleElementComponent获取激活QTE的Tag"}),this.aat.AddBuff(t,{InstigatorId:this.aat.CreatureDataId,Reason:"RoleElementComponent激活Buff特效"})):(this.aat.RemoveBuff(CharacterBuffIds_1.buffId.ActivateQte,-1,"RoleElementComponent移除激活QTE的Tag"),this.aat.RemoveBuff(t,-1,"RoleElementComponent移除Buff特效")))}get qXo(){return this.bXo}get RoleElementType(){return this.yte.GetCurrentValue(EAttributeId.ElementPropertyType)}get RoleElementEnergy(){var t=this.FXo;return 0<t?this.yte.GetCurrentValue(t):0}get FXo(){return CharacterAttributeTypes_1.elementEnergyAttributeIds[this.RoleElementType-1]??0}GXo(t){t>=CharacterAttributeTypes_1.ELEMENT_POWER_MAX-Number.EPSILON&&(t=ModelManager_1.ModelManager.FormationModel.GetFormationInsByEntityId(this.Entity.Id)?.IsControl(),!this.qXo)&&t&&FormationDataController_1.FormationDataController.GlobalIsInFight&&(this.qXo=!0,this.aat.TriggerEvents(9,this.aat,{ElementType:this.RoleElementType}))}ActivateFusion(t){var e=t.CheckGetComponent(79),n={ElementType:this.RoleElementType,ElementType2:e};this.aat.TriggerEvents(10,e.aat,n),e.aat.TriggerEvents(13,this.aat,n),this.kXo(t)}kXo(t){this.aat.AddBuff(CharacterBuffIds_1.buffId.ElementClean,{InstigatorId:t.GetComponent(0).GetCreatureDataId(),Reason:"RoleElementComponent清空元素能量"})}};RoleElementComponent.VXo=new Map([[1,CharacterBuffIds_1.fillElementBuffId.Ice],[2,CharacterBuffIds_1.fillElementBuffId.Fire],[3,CharacterBuffIds_1.fillElementBuffId.Thunder],[4,CharacterBuffIds_1.fillElementBuffId.Wind],[5,CharacterBuffIds_1.fillElementBuffId.Light],[6,CharacterBuffIds_1.fillElementBuffId.Dark]]),RoleElementComponent=RoleElementComponent_1=__decorate([(0,RegisterComponent_1.RegisterComponent)(79)],RoleElementComponent),exports.RoleElementComponent=RoleElementComponent;
//# sourceMappingURL=RoleElementComponent.js.map