
"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoadingController=void 0;const Log_1=require("../../../Core/Common/Log"),NetDefine_1=require("../../../Core/Define/Net/NetDefine"),Net_1=require("../../../Core/Net/Net"),MathCommon_1=require("../../../Core/Utils/Math/MathCommon"),EventDefine_1=require("../../Common/Event/EventDefine"),EventSystem_1=require("../../Common/Event/EventSystem"),ModelManager_1=require("../../Manager/ModelManager"),CharacterBuffIds_1=require("../../NewWorld/Character/Common/Component/Abilities/CharacterBuffIds"),UiControllerBase_1=require("../../Ui/Base/UiControllerBase"),UiManager_1=require("../../Ui/UiManager"),GameModeController_1=require("../../World/Controller/GameModeController"),BlackScreenController_1=require("../BlackScreen/BlackScreenController"),UiLoginSceneManager_1=require("../UiComponent/UiLoginSceneManager"),NormalLoadingViewGlobalData_1=require("./Data/NormalLoadingViewGlobalData");class LoadingController extends UiControllerBase_1.UiControllerBase{static OnInit(){return ModelManager_1.ModelManager.LoadingModel.Speed=GameModeController_1.BASE_SPEED,!0}static OnRegisterNetEvent(){Net_1.Net.Register(NetDefine_1.ENotifyMessageId.PushDataCompleteNotify,LoadingController.W0i)}static OnUnRegisterNetEvent(){Net_1.Net.UnRegister(NetDefine_1.ENotifyMessageId.PushDataCompleteNotify)}static OnAddEvents(){EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.WorldDone,LoadingController.MSe),EventSystem_1.EventSystem.Add(EventDefine_1.EEventName.ChangeTeam,LoadingController.K0i)}static OnRemoveEvents(){EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.WorldDone,LoadingController.MSe),EventSystem_1.EventSystem.Remove(EventDefine_1.EEventName.ChangeTeam,LoadingController.K0i)}static async Q0i(){var e,o,a=ModelManager_1.ModelManager.FormationModel.GetFormationEntities();for(const n of a)n.Valid&&(e=n.Entity.GetComponent(156))&&e.AddBuff(CharacterBuffIds_1.buffId.Invisible,{InstigatorId:e.CreatureDataId,Reason:"HandleRoleBuffChangeInLoading"});await NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FinishPromise?.Promise;for(const r of a)r.Valid&&(o=r.Entity.GetComponent(156))&&o.RemoveBuff(CharacterBuffIds_1.buffId.Invisible,-1,"HandleRoleBuffChangeInLoading")}static async GameModeOpenLoading(e){var o;NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FirstProgressPromise?Log_1.Log.CheckInfo()&&Log_1.Log.Info("Loading",9,"Loading界面正在打开中"):((o=ModelManager_1.ModelManager.LoadingModel.GetIsLoginToWorld())&&UiLoginSceneManager_1.UiLoginSceneManager.Destroy(),Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Loading",9,"打开Loading界面",["从登录界面进入大世界",o]),LoadingController.OpenLoadingView(void 0,e)),await NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FirstProgressPromise.Promise,BlackScreenController_1.BlackScreenController.RemoveBlackScreen("None","LeaveScene")}static async GameModeCloseLoading(){Log_1.Log.CheckDebug()&&Log_1.Log.Debug("Loading",9,"关闭Loading界面"),await LoadingController.CloseLoadingView(),ModelManager_1.ModelManager.LoginModel.CleanCreateData()}static OpenLoadingView(o,a){NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.CreateFirstProgressPromise(),NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.CreateFinishPromisePromise(),LoadingController.SetProgress(GameModeController_1.OPENLOADING_END_PROGRESS,void 0,1,!0,!1),UiManager_1.UiManager.OpenView("LoadingView",void 0,e=>{o?.(e),LoadingController.SetProgress(GameModeController_1.OPENLOADING_END_PROGRESS,()=>{NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FinishFirstProgressPromise(),a?.(!0)},1,!1,!1)})}static async CloseLoadingView(){this.SetProgress(GameModeController_1.LOAD_FINISHED_PROGRESS,()=>{NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FinishEndPromise()},GameModeController_1.LOADED_SPEED_RATE),await NormalLoadingViewGlobalData_1.NormalLoadingViewGlobalData.FinishPromise?.Promise}static OpenFadeLoadingView(e){UiManager_1.UiManager.OpenView("FadeLoadingView",void 0,e)}static CloseFadeLoadingView(e){UiManager_1.UiManager.CloseView("FadeLoadingView",e)}static OpenVideoCenterView(e){UiManager_1.UiManager.OpenView("PlotTransitionView",void 0,e)}static CloseVideoCenterView(e){UiManager_1.UiManager.CloseView("PlotTransitionView",e)}static SetProgress(e,o=void 0,a=1,n=!1,r=!0){Log_1.Log.CheckInfo()&&Log_1.Log.Info("Loading",17,"SetProgress",["progress",e]);var i=ModelManager_1.ModelManager.LoadingModel;o&&i.ReachHandleQueue.Push([e,o]),n&&(i.CurrentProgress=0,i.ReachHandleQueue.Clear()),i.SpeedRate=a,i.NextProgress=e,i.NextProgress=Math.min(i.NextProgress,MathCommon_1.MathCommon.ProgressTotalValue),r||(i.CurrentProgress=e)}static AddProgress(e,o){var a=ModelManager_1.ModelManager.LoadingModel;for(a.NextProgress=Math.min(a.NextProgress+e,o),a.NextProgress=Math.min(a.NextProgress,MathCommon_1.MathCommon.ProgressTotalValue);a.ReachHandleQueue.Size;){var n=a.ReachHandleQueue.Front;if(n[0]>a.CurrentProgress)break;a.ReachHandleQueue.Pop(),n[1](),Log_1.Log.CheckInfo()&&Log_1.Log.Info("Loading",17,"AddProgress",["progress",e],["maxProgress",o])}}}exports.LoadingController=LoadingController,(_a=LoadingController).W0i=e=>{EventSystem_1.EventSystem.Emit(EventDefine_1.EEventName.OnLoadingNetDataDone)},LoadingController.MSe=()=>{UiManager_1.UiManager.IsViewOpen("UidView")||UiManager_1.UiManager.OpenView("UidView")},LoadingController.K0i=()=>{ModelManager_1.ModelManager.LoadingModel.IsLoadingView&&_a.Q0i().finally(void 0)};
//# sourceMappingURL=LoadingController.js.map